# üìã Guia Completo de Integra√ß√£o Supabase - StorySpark

## üéØ Vis√£o Geral

Este guia detalha como conectar seu projeto Lovable ao banco Supabase existente, configurar todas as policies de seguran√ßa, edge functions e sistema de roles.

---

## üìä Estrutura do Banco (An√°lise)

### ‚úÖ **Estrutura Atual Identificada:**

#### üè¢ **Workspaces & Usu√°rios**
- `profiles` - Perfis completos com planos e tokens
- `workspaces` - Espa√ßos de trabalho multi-tenant
- `workspace_members` - Roles: OWNER, ADMIN, MEMBER
- `user_preferences` - Configura√ß√µes personalizadas

#### üëë **Sistema Admin (Multi-n√≠vel)**
- `admin_managers` - Admins com roles: super_admin, admin, blog_admin, analytics_admin, support_admin
- `admin_users_overview` - Dashboard de usu√°rios
- `admin_integrations` - APIs (Stripe, SendGrid, Google, Facebook, etc)
- `admin_llm_settings` - Configura√ß√µes IA (OpenAI, Anthropic, Gemini, etc)
- `admin_audit_logs` - Auditoria completa
- `admin_role_permissions` - Permiss√µes granulares

#### üé® **Conte√∫do & IA**
- `campaigns` - Campanhas dos usu√°rios
- `generated_copies` - Conte√∫do gerado por IA
- `templates` - Templates p√∫blicos/privados
- `brand_voices` - Tom de voz da marca
- `target_personas` - Personas de marketing
- `ai_usage_logs` - Logs detalhados de uso IA

#### üìà **Analytics & Monitoramento**
- `admin_analytics` - M√©tricas de neg√≥cio
- `system_metrics` - Performance do sistema
- `system_logs` - Logs de sistema
- `usage_events` - Eventos de uso
- `metrics_cache` - Cache de m√©tricas

#### üí≥ **Billing & Seguran√ßa**
- `billing_events` - Eventos Stripe
- `security_settings` - Configura√ß√µes de seguran√ßa
- `admin_invites` - Convites de admin

---

## üîê 1. CONFIGURA√á√ÉO DE RLS POLICIES

### **1.1 Profiles (Usu√°rios)**
```sql
-- Pol√≠tica: Usu√°rios podem ver/editar apenas pr√≥prio perfil
CREATE POLICY "Users can view own profile" ON profiles
    FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update own profile" ON profiles
    FOR UPDATE USING (auth.uid() = id);

-- Pol√≠tica: Admins podem ver todos os perfis
CREATE POLICY "Admins can view all profiles" ON profiles
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM admin_managers 
            WHERE user_id = auth.uid() 
            AND status = 'active'
        )
    );
```

### **1.2 Admin Managers (Controle Super Admin)**
```sql
-- Pol√≠tica: Apenas super_admin pode gerenciar outros admins
CREATE POLICY "Super admin can manage admins" ON admin_managers
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM admin_managers 
            WHERE user_id = auth.uid() 
            AND role = 'super_admin' 
            AND status = 'active'
        )
    );

-- Pol√≠tica: Admins podem ver pr√≥prio registro
CREATE POLICY "Admins can view own record" ON admin_managers
    FOR SELECT USING (user_id = auth.uid());
```

### **1.3 Workspaces (Multi-tenant)**
```sql
-- Pol√≠tica: Membros podem ver workspace
CREATE POLICY "Members can view workspace" ON workspaces
    FOR SELECT USING (
        id IN (
            SELECT workspace_id FROM workspace_members 
            WHERE user_id = auth.uid()
        )
        OR owner_id = auth.uid()
    );

-- Pol√≠tica: Apenas owner pode editar workspace
CREATE POLICY "Owner can update workspace" ON workspaces
    FOR UPDATE USING (owner_id = auth.uid());
```

### **1.4 Admin Analytics (Dados Sens√≠veis)**
```sql
-- Pol√≠tica: Apenas analytics_admin e super_admin
CREATE POLICY "Analytics admin access" ON admin_analytics
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM admin_managers 
            WHERE user_id = auth.uid() 
            AND role IN ('super_admin', 'analytics_admin')
            AND status = 'active'
        )
    );
```

### **1.5 System Logs (Auditoria)**
```sql
-- Pol√≠tica: Apenas super_admin e support_admin
CREATE POLICY "System logs admin access" ON system_logs
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM admin_managers 
            WHERE user_id = auth.uid() 
            AND role IN ('super_admin', 'support_admin')
            AND status = 'active'
        )
    );
```

---

## ‚ö° 2. EDGE FUNCTIONS NECESS√ÅRIAS

### **2.1 Autentica√ß√£o e Roles**
```typescript
// functions/auth-role-check/index.ts
import { createClient } from '@supabase/supabase-js'

export default async function handler(req: Request) {
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL')!,
    Deno.env.get('SUPABASE_SERVICE_KEY')!
  )
  
  const { data: { user }, error } = await supabase.auth.getUser(
    req.headers.get('Authorization')?.replace('Bearer ', '')
  )
  
  if (!user) return new Response('Unauthorized', { status: 401 })
  
  // Verificar role admin
  const { data: adminRole } = await supabase
    .from('admin_managers')
    .select('role, status, permissions')
    .eq('user_id', user.id)
    .eq('status', 'active')
    .single()
  
  return new Response(JSON.stringify({
    user_id: user.id,
    is_admin: !!adminRole,
    admin_role: adminRole?.role,
    permissions: adminRole?.permissions
  }), {
    headers: { 'Content-Type': 'application/json' }
  })
}
```

### **2.2 Admin Dashboard Metrics**
```typescript
// functions/admin-dashboard-metrics/index.ts
import { createClient } from '@supabase/supabase-js'

export default async function handler(req: Request) {
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL')!,
    Deno.env.get('SUPABASE_SERVICE_KEY')!
  )
  
  // Verificar permiss√£o admin
  const authHeader = req.headers.get('Authorization')
  // ... verifica√ß√£o de auth ...
  
  // Buscar m√©tricas do dashboard
  const [users, campaigns, revenue, aiUsage] = await Promise.all([
    supabase.from('admin_users_overview').select('*', { count: 'exact' }),
    supabase.from('campaigns').select('*', { count: 'exact' }),
    supabase.from('billing_events').select('amount').eq('processed', true),
    supabase.from('ai_usage_logs').select('tokens_used, cost')
  ])
  
  return new Response(JSON.stringify({
    total_users: users.count,
    active_campaigns: campaigns.count,
    total_revenue: revenue.data?.reduce((sum, event) => sum + event.amount, 0),
    ai_tokens_used: aiUsage.data?.reduce((sum, log) => sum + log.tokens_used, 0)
  }))
}
```

### **2.3 User Management**
```typescript
// functions/admin-user-management/index.ts
export default async function handler(req: Request) {
  const { method } = req
  const supabase = createClient(...)
  
  switch (method) {
    case 'GET':
      // Listar usu√°rios com filtros
      return getUsersList()
    case 'PUT':
      // Atualizar usu√°rio (ban, upgrade, etc)
      return updateUser()
    case 'DELETE':
      // Deletar usu√°rio
      return deleteUser()
  }
}
```

### **2.4 Billing Integration**
```typescript
// functions/stripe-webhook/index.ts
import Stripe from 'stripe'

export default async function handler(req: Request) {
  const stripe = new Stripe(Deno.env.get('STRIPE_SECRET_KEY')!)
  const signature = req.headers.get('stripe-signature')!
  
  const event = stripe.webhooks.constructEvent(
    await req.text(),
    signature,
    Deno.env.get('STRIPE_WEBHOOK_SECRET')!
  )
  
  // Processar eventos Stripe
  switch (event.type) {
    case 'customer.subscription.created':
      await handleSubscriptionCreated(event.data.object)
      break
    case 'invoice.payment_succeeded':
      await handlePaymentSucceeded(event.data.object)
      break
  }
  
  return new Response('OK')
}
```

---

## üõ† 3. CONFIGURA√á√ÉO INICIAL

### **3.1 Vari√°veis de Ambiente (Supabase Secrets)**
```bash
# IA Providers
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=sk-ant-...
GEMINI_API_KEY=...

# Email
SENDGRID_API_KEY=SG....
RESEND_API_KEY=re_...

# Pagamentos
STRIPE_SECRET_KEY=sk_...
STRIPE_WEBHOOK_SECRET=whsec_...

# Analytics
GOOGLE_ANALYTICS_ID=GA...
MIXPANEL_TOKEN=...

# Social Login
GOOGLE_CLIENT_SECRET=...
FACEBOOK_APP_SECRET=...

# Monitoramento
SENTRY_DSN=https://...
```

### **3.2 Primeiro Super Admin**
```sql
-- Inserir primeiro super admin manualmente
INSERT INTO admin_managers (
    user_id,
    email,
    full_name,
    role,
    status,
    permissions,
    activated_at
) VALUES (
    '[SEU_USER_ID]',
    '[SEU_EMAIL]',
    '[SEU_NOME]',
    'super_admin',
    'active',
    '["*"]'::jsonb,
    NOW()
);
```

---

## üîí 4. SISTEMA DE PERMISS√ïES

### **4.1 Estrutura de Roles**
```typescript
type AdminRole = 
  | 'super_admin'    // Acesso total
  | 'admin'          // Acesso geral exceto system settings
  | 'blog_admin'     // Apenas gest√£o de conte√∫do
  | 'analytics_admin' // Apenas dashboards e m√©tricas  
  | 'support_admin'  // Apenas usu√°rios e tickets

type Permission = 
  | 'users.read' | 'users.write' | 'users.delete'
  | 'campaigns.read' | 'campaigns.moderate'
  | 'analytics.read' | 'analytics.export'
  | 'system.read' | 'system.write'
  | 'integrations.read' | 'integrations.write'
  | 'audit.read'
```

### **4.2 Middleware de Verifica√ß√£o**
```typescript
// lib/auth-middleware.ts
export function requireAdminRole(allowedRoles: AdminRole[]) {
  return async (req: Request) => {
    const { user_id, admin_role } = await checkAuthRole(req)
    
    if (!admin_role || !allowedRoles.includes(admin_role)) {
      throw new Error('Insufficient permissions')
    }
    
    return { user_id, admin_role }
  }
}

// Uso nas rotas
app.get('/admin/users', requireAdminRole(['super_admin', 'admin']), handler)
```

---

## üìù 5. PASSOS DE INTEGRA√á√ÉO

### **Passo 1: Conectar Supabase**
1. Click no bot√£o verde "Supabase" no Lovable
2. Conectar ao projeto existente
3. Verificar detec√ß√£o das tabelas

### **Passo 2: Aplicar Policies**
```sql
-- Execute todas as policies RLS listadas acima
-- Importante: testar com usu√°rio n√£o-admin primeiro
```

### **Passo 3: Deploy Edge Functions**
```bash
# Deploy functions
supabase functions deploy auth-role-check
supabase functions deploy admin-dashboard-metrics
supabase functions deploy admin-user-management
supabase functions deploy stripe-webhook
```

### **Passo 4: Configurar Secrets**
```bash
# Adicionar secrets via Supabase Dashboard
supabase secrets set OPENAI_API_KEY=sk-...
supabase secrets set STRIPE_SECRET_KEY=sk-...
# ... outros secrets
```

### **Passo 5: Criar Primeiro Admin**
```sql
-- Executar INSERT do primeiro super_admin
-- Usar seu user_id do auth.users
```

### **Passo 6: Testar Integra√ß√µes**
- [ ] Login/logout funciona
- [ ] Dashboard admin carrega m√©tricas
- [ ] Permiss√µes funcionam por role
- [ ] Webhook Stripe processa eventos
- [ ] IA providers conectados

---

## ‚ö†Ô∏è SEGURAN√áA CR√çTICA

### **üîê Checklist de Seguran√ßa**
- [ ] RLS habilitado em TODAS as tabelas sens√≠veis
- [ ] Policies testadas com usu√°rios diferentes
- [ ] Secrets nunca no c√≥digo (apenas Supabase Secrets)
- [ ] Admin audit logs capturando a√ß√µes cr√≠ticas
- [ ] Rate limiting nas edge functions
- [ ] Valida√ß√£o de input em todos endpoints
- [ ] CORS configurado adequadamente

### **üö® Tabelas Cr√≠ticas (RLS Obrigat√≥rio)**
- `admin_managers` - Controle de acesso admin
- `admin_integrations` - API keys sens√≠veis  
- `admin_llm_settings` - Configura√ß√µes IA
- `billing_events` - Dados financeiros
- `security_settings` - Configura√ß√µes sistema
- `admin_audit_logs` - Logs de auditoria

---

## üìä 6. MONITORAMENTO P√ìS-DEPLOY

### **M√©tricas para Acompanhar:**
- Response time das edge functions
- Taxa de erro nas integra√ß√µes
- Uso de tokens IA por usu√°rio
- Eventos de billing processados
- Tentativas de acesso n√£o autorizado

### **Logs Importantes:**
- `admin_audit_logs` - A√ß√µes administrativas
- `system_logs` - Erros de sistema  
- `ai_usage_logs` - Custos de IA
- `billing_events` - Status pagamentos

---

## üéØ RESULTADO FINAL

Ap√≥s a integra√ß√£o, voc√™ ter√°:

‚úÖ **Dashboard Admin Completo** com m√©tricas em tempo real  
‚úÖ **Sistema de Roles Granular** (5 tipos de admin)  
‚úÖ **Integra√ß√£o Multi-Provider** (Stripe, OpenAI, SendGrid, etc)  
‚úÖ **Auditoria Completa** de todas a√ß√µes administrativas  
‚úÖ **Billing Automatizado** via Stripe webhooks  
‚úÖ **Monitoramento Sistema** com m√©tricas de performance  
‚úÖ **Seguran√ßa Enterprise** com RLS e permiss√µes  

---

## üìû PR√ìXIMOS PASSOS

1. **Conectar Supabase** no Lovable (bot√£o verde)
2. **Aplicar RLS Policies** (copiar/colar SQLs acima)
3. **Deploy Edge Functions** (4 functions principais)
4. **Configurar Secrets** (API keys via dashboard)
5. **Criar Primeiro Admin** (INSERT manual)
6. **Testar Integra√ß√£o** (checklist de seguran√ßa)

**Tempo estimado:** 2-3 horas para setup completo

---

*Documento criado para StorySpark SaaS - Vers√£o 1.0*