name: VPS Diagnostic

# Pode ser executado manualmente ou automaticamente apÃ³s deploys
on:
  workflow_dispatch:  # Executar manualmente
    inputs:
      debug_level:
        description: 'Debug Level (basic, detailed, full)'
        required: false
        default: 'detailed'
        type: choice
        options:
        - basic
        - detailed  
        - full
  
  workflow_call:  # Pode ser chamado por outros workflows

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  diagnose-vps:
    runs-on: ubuntu-latest
    
    steps:
    - name: VPS Health Check & Diagnosis
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          echo "ğŸ” StorySpark VPS Diagnostic Report"
          echo "=================================="
          echo "ğŸ“… Timestamp: $(date)"
          echo "ğŸ–¥ï¸  Server: $(hostname)"
          echo "ğŸ“ Debug Level: ${{ github.event.inputs.debug_level || 'detailed' }}"
          echo ""
          
          # InformaÃ§Ãµes bÃ¡sicas do sistema
          echo "ğŸ–¥ï¸  SYSTEM INFO:"
          echo "CPU: $(nproc) cores"
          echo "Memory: $(free -h | awk 'NR==2{printf "%.1fGB used / %.1fGB total (%.0f%%)", $3/1024/1024, $2/1024/1024, $3*100/$2}')"
          echo "Disk: $(df -h / | awk 'NR==2{printf "%s used / %s total (%s)", $3, $2, $5}')"
          echo ""
          
          # Status dos containers StorySpark
          echo "ğŸ“Š STORYSPARK CONTAINERS:"
          if docker ps | grep -q storyspark; then
            docker ps | grep storyspark | while read line; do
              container_name=$(echo $line | awk '{print $NF}')
              container_status=$(echo $line | awk '{print $7}')
              container_ports=$(echo $line | awk '{print $6}')
              echo "  âœ… $container_name: $container_status ($container_ports)"
            done
          else
            echo "  âŒ No StorySpark containers running"
          fi
          echo ""
          
          # Status do Traefik
          echo "ğŸŒ TRAEFIK STATUS:"
          if docker ps | grep -q traefik; then
            traefik_status=$(docker ps | grep traefik | awk '{print $7}')
            traefik_ports=$(docker ps | grep traefik | awk '{print $6}')
            echo "  âœ… Traefik: $traefik_status ($traefik_ports)"
          else
            echo "  âŒ Traefik not running"
          fi
          echo ""
          
          # Network inspection
          echo "ğŸ”— NETWORK STATUS:"
          if docker network ls | grep -q traefik; then
            echo "  âœ… Traefik network exists"
            traefik_containers=$(docker network inspect traefik | jq -r '.[0].Containers | keys[]' 2>/dev/null | wc -l)
            echo "  ğŸ“Š Containers in traefik network: $traefik_containers"
          else
            echo "  âŒ Traefik network not found"
          fi
          echo ""
          
          # Verificar imagens
          echo "ğŸ³ DOCKER IMAGES:"
          if docker images | grep -q storyspark; then
            echo "  âœ… StorySpark images found:"
            docker images | grep storyspark | awk '{printf "    ğŸ“¦ %s:%s (%s)\n", $1, $2, $7}'
          else
            echo "  âŒ No StorySpark images found"
          fi
          echo ""
          
          # Logs recentes (se debug_level >= detailed)
          if [ "${{ github.event.inputs.debug_level || 'detailed' }}" != "basic" ]; then
            echo "ğŸ“‹ CONTAINER LOGS (last 10 lines):"
            for container in storyspark-app storyspark-www storyspark-admin; do
              if docker ps | grep -q $container; then
                echo "  --- $container ---"
                docker logs $container --tail=10 2>&1 | sed 's/^/    /'
              else
                echo "  âŒ $container: not running"
              fi
              echo ""
            done
            
            echo "ğŸ” TRAEFIK LOGS (last 15 lines):"
            if docker ps | grep -q traefik; then
              docker logs traefik --tail=15 2>&1 | sed 's/^/  /'
            else
              echo "  âŒ Traefik not running"
            fi
            echo ""
          fi
          
          # DiagnÃ³stico completo (se debug_level = full)
          if [ "${{ github.event.inputs.debug_level || 'detailed' }}" = "full" ]; then
            echo "ğŸ·ï¸  CONTAINER LABELS (StorySpark-app):"
            if docker ps | grep -q storyspark-app; then
              docker inspect storyspark-app | jq '.[0].Config.Labels' 2>/dev/null | sed 's/^/  /' || echo "  âŒ Could not inspect labels"
            else
              echo "  âŒ storyspark-app not running"
            fi
            echo ""
            
            echo "ğŸ”§ TRAEFIK CONFIGURATION:"
            if docker ps | grep -q traefik; then
              echo "  ğŸ“Š Traefik dashboard (if enabled): http://$(hostname):8080"
              docker exec traefik wget -qO- http://localhost:8080/api/rawdata 2>/dev/null | jq '.routers | keys[]' 2>/dev/null | grep storyspark || echo "  âŒ No StorySpark routes found in Traefik"
            fi
            echo ""
            
            echo "ğŸŒ PORT TESTS:"
            for port in 80 443 3000; do
              if netstat -tuln 2>/dev/null | grep -q ":$port "; then
                echo "  âœ… Port $port: LISTENING"
              else
                echo "  âŒ Port $port: NOT LISTENING"
              fi
            done
            echo ""
          fi
          
          # Resumo final
          echo "ğŸ“ˆ SUMMARY:"
          storyspark_running=$(docker ps | grep storyspark | wc -l)
          traefik_running=$(docker ps | grep traefik | wc -l)
          
          if [ $storyspark_running -gt 0 ] && [ $traefik_running -gt 0 ]; then
            echo "  âœ… Status: HEALTHY ($storyspark_running StorySpark containers + Traefik)"
            echo "  ğŸŒ URLs should be accessible:"
            echo "     â€¢ https://app.storyspark.com.br"
            echo "     â€¢ https://www.storyspark.com.br"
            echo "     â€¢ https://admin.storyspark.com.br"
          elif [ $traefik_running -eq 0 ]; then
            echo "  âŒ Status: CRITICAL - Traefik not running"
            echo "  ğŸ”§ Action: Start Traefik first"
          elif [ $storyspark_running -eq 0 ]; then
            echo "  âš ï¸  Status: WARNING - StorySpark containers not running"
            echo "  ğŸ”§ Action: Deploy StorySpark containers"
          else
            echo "  âŒ Status: UNKNOWN - Mixed state"
          fi
          
          echo ""
          echo "âœ… Diagnostic Complete!"
          echo "ğŸ“Š Run this workflow anytime via: Actions â†’ VPS Diagnostic â†’ Run workflow"
